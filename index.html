<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fixed-Layout ID Card Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CropperJS (for photo crop) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <style>
    :root {
      --card-w: 690px; /* native template size */
      --card-h: 1050px;
    }

    /* Page layout ------------------------------------------------------- */
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #f1f4f9, #dff3ff);
      color: #333;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .form-container {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 320px;
      box-sizing: border-box;
    }

    .form-container h2{
      margin-bottom:10px;
      color:#2c3e50;
      font-size:22px;
      border-bottom:2px solid #ddd;
      padding-bottom:5px;
    }

    input[type="text"],
    input[type="file"]{
      padding:10px;
      font-size:15px;
      border:1px solid #ccc;
      border-radius:8px;
      outline:none;
      transition:0.3s;
      width:100%;
      box-sizing:border-box;
    }
    input[type="text"]:focus{border-color:#4a90e2;box-shadow:0 0 3px #4a90e2;}

    button{
      padding:10px;
      font-size:16px;
      background:#4a90e2;
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      transition:background 0.3s;
      width:100%;
      box-sizing:border-box;
    }
    button:hover{background:#357abd;}

    #downloadLink{
      text-decoration:none;
      padding:10px;
      text-align:center;
      background:#2ecc71;
      color:#fff;
      border-radius:8px;
      display:none; /* shown after generate */
      margin-top:5px;
      width:100%;
      box-sizing:border-box;
    }

    /* Crop area --------------------------------------------------------- */
    #crop-area{
      width:100%;
      height:auto;
      border:2px dashed #aaa;
      padding:5px;
      border-radius:10px;
      background-color:#f9f9f9;
      text-align:center;
    }
    #cropImage{max-width:100%;display:none;margin-top:10px;border-radius:5px;max-height:300px;object-fit:contain;}

    /* Generated preview image ------------------------------------------ */
    .generated-wrapper{
      width:90vw;
      max-width:var(--card-w);
      aspect-ratio:690/1050; /* maintain card ratio responsively */
      position:relative;
    }
    #generatedPreview{
      position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;
      border:4px solid #0077ff;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.2);
      background:#eee;
    }

    /* Small helper text */
    .helper-note{font-size:12px;color:#666;margin-top:-4px;}
     
    #fullscreenLoader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6); /* dull overlay */
  display: none; /* show only when needed */
  z-index: 9999;
  justify-content: center;
  align-items: center;
}

#fullscreenLoader .loader-content {
  text-align: center;
  color: white;
}

#fullscreenLoader img {
  width: 100px;
  height: auto;
  margin-bottom: 10px;
}




  </style>
</head>
<body>
  <div class="form-container">
    <h2>Student Details</h2>
    <input type="text" placeholder="Admission No" id="inputAdmn" />
    <input type="text" placeholder="PEN No" id="inputPEN" />
    <input type="text" placeholder="Child ID" id="inputChild" />
    <input type="text" placeholder="Father's Name" id="inputFather" />
    <input type="text" placeholder="Cell No" id="inputCell" />
    <input type="text" placeholder="Student Name" id="inputName" />
    <input type="file" id="photoInput" accept="image/*" />
    <div id="crop-area"><img id="cropImage" alt="Crop source" /></div>
    <div class="helper-note">Select a photo, crop, then generate.</div>
    <button type="button" onclick="cropAndStorePhoto()">Crop & Insert Photo</button>
    <button type="button" onclick="generateID()">Generate ID Card</button>
    <a id="downloadLink" download="idcard.png">Download ID Card</a>
    <div id="loading" style="display:none; text-align:center;">
    <img src="https://i.postimg.cc/XNtP5hP3/mg-logo.gif" alt="Loading..." width="500" />
  <p style="font-size:14px; color:#555;">Uploading, please wait...</p>
</div>

  </div>
  <div id="fullscreenLoader">
  <div class="loader-content">
    <img src="loading animation.gif" alt="Loading..." />
    <p>Uploading, please wait...</p>
  </div>
</div>

  <!-- Responsive display of the generated (final) card -->
  <div class="generated-wrapper">
    <img id="generatedPreview" alt="Generated ID Card Preview" />
  </div>

  <!-- Offscreen canvas used for rendering the TRUE card at native resolution -->
  <canvas id="finalCanvas" width="690" height="1050" style="display:none;"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    /**********************************************************************
     * CONFIGURATION: Card size & drawing coordinates (pixels)
     * Update these values to reposition content on the template.
     **********************************************************************/
    const CARD_W = 690;   // template native width
    const CARD_H = 1050;   // template native height

   const coords = {
  photo:  {x:203, y:310, w:271, h:341},
  admn:   {x:195, y:265, color:'rgb(107,11,67)', size:40, align:'left', weight: 'bold'},
  pen:    {x:315, y:713, color:'#000', size:28, align:'left', weight: '600'},
  child:  {x:315, y:753, color:'#000', size:28, align:'left', weight: 'bold'},
  father: {x:360, y:935, color:'#fff', size:28, align:'left', weight: '700'},
  cell:   {x:360, y:975, color:'#fff', size:28, align:'left', weight: 'bold'},
  name:   {x:CARD_W/2, y:672, color:'red', size:30, align:'center', maxWidth:600, weight: 'bold'}
};



    /**********************************************************************
     * DOM refs
     **********************************************************************/
    const inpAdmn   = document.getElementById('inputAdmn');
    const inpPEN    = document.getElementById('inputPEN');
    const inpChild  = document.getElementById('inputChild');
    const inpFather = document.getElementById('inputFather');
    const inpCell   = document.getElementById('inputCell');
    const inpName   = document.getElementById('inputName');

    const photoInput    = document.getElementById('photoInput');
    const cropImage     = document.getElementById('cropImage');
    const generatedPreview = document.getElementById('generatedPreview');
    const downloadLink  = document.getElementById('downloadLink');

    const finalCanvas = document.getElementById('finalCanvas');
    const ctx = finalCanvas.getContext('2d');

    let cropper = null;
    let croppedPhotoImg = null;  // Image element built from cropped data
    let templateImg = null;      // Background template image

    /**********************************************************************
     * Load template background once
     **********************************************************************/
    function loadTemplate(){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>resolve(img);
        img.onerror = reject;
        img.src = 'idcard-template1.png'; // make sure file is in same folder
      });
    }

    loadTemplate().then(img=>{templateImg = img;}).catch(err=>{
      alert('Template image failed to load. Check path.');
      console.error(err);
    });

    /**********************************************************************
     * Photo selection & cropping
     **********************************************************************/
    photoInput.addEventListener('change', function(){
      const file = this.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      cropImage.src = url;
      cropImage.style.display = 'block';
      cropImage.onload = ()=>{
        if(cropper) cropper.destroy();
        cropper = new Cropper(cropImage, {
          aspectRatio: 13/16,
          viewMode: 1,
          autoCropArea: 1,
        });
      };
    });

    function cropAndStorePhoto(){
      if(!cropper){
        alert('Please choose and crop a photo first.');
        return;
      }
      const canvas = cropper.getCroppedCanvas({width:coords.photo.w, height:coords.photo.h});
      const dataURL = canvas.toDataURL('image/png');
      // create reusable <img> for drawing to final canvas later
      croppedPhotoImg = new Image();
      croppedPhotoImg.src = dataURL;
      croppedPhotoImg.onload = ()=>{
        // optional immediate regenerate preview after crop
        generateID(true); // silent = true so we don't block if fields empty
      };
    }

    /**********************************************************************
     * Text drawing helpers
     **********************************************************************/
function drawTextFit(ctx, text, x, y, pxSize, color, align='left', maxWidth=null, weight='normal'){
  ctx.textBaseline = 'top';
  ctx.fillStyle = color;
  ctx.textAlign = align;
  let size = pxSize;
  ctx.font = `${weight} ${size}px 'Arial', sans-serif`;
  if(maxWidth){
    while(size > 8 && ctx.measureText(text).width > maxWidth){
      size -= 1;
      ctx.font = `${weight} ${size}px 'Arial', sans-serif`;
    }
  }
  ctx.fillText(text, x, y);
}


    /**********************************************************************
     * Generate final card image (true pixel-perfect)
     * silent=true skips required-field alerts (for auto-preview after crop)
     **********************************************************************/
    function generateID(silent=false){
      if(!templateImg){
        alert('Template not loaded yet. Please wait a moment and try again.');
        return;
      }
      const required = [inpAdmn,inpPEN,inpChild,inpFather,inpCell,inpName];
      const missing = required.filter(i=>i.value.trim()==="");
      if(!silent && missing.length){
        alert('Please fill in all the fields before generating.');
        return;
      }
      if(!croppedPhotoImg){
        if(!silent) alert('Please crop a photo first.');
        return;
      }

      // Clear canvas
      ctx.clearRect(0,0,CARD_W,CARD_H);

      // Draw background template
      ctx.drawImage(templateImg, 0,0, CARD_W, CARD_H);

      // Draw cropped photo
      const p = coords.photo;
      ctx.drawImage(croppedPhotoImg, p.x, p.y, p.w, p.h);
      ctx.lineWidth = 2; ctx.strokeStyle = '#000'; ctx.strokeRect(p.x, p.y, p.w, p.h);

      // Draw text fields
      drawTextFit(ctx, inpAdmn.value,  coords.admn.x,  coords.admn.y,  coords.admn.size,  coords.admn.color,  coords.admn.align, null, coords.admn.weight);
drawTextFit(ctx, inpPEN.value,   coords.pen.x,   coords.pen.y,   coords.pen.size,   coords.pen.color,   coords.pen.align, null, coords.pen.weight);
drawTextFit(ctx, inpChild.value, coords.child.x, coords.child.y, coords.child.size, coords.child.color, coords.child.align, null, coords.child.weight);
drawTextFit(ctx, inpFather.value,coords.father.x,coords.father.y,coords.father.size,coords.father.color,coords.father.align, null, coords.father.weight);
drawTextFit(ctx, inpCell.value,  coords.cell.x,  coords.cell.y,  coords.cell.size,  coords.cell.color,  coords.cell.align, null, coords.cell.weight);
drawTextFit(ctx, inpName.value,  coords.name.x,  coords.name.y,  coords.name.size,  coords.name.color,  coords.name.align, coords.name.maxWidth, coords.name.weight);

      // Update preview <img>
      const dataURL = finalCanvas.toDataURL('image/png');
      generatedPreview.src = dataURL;

      // Prep download link
      const safeAdmn = (inpAdmn.value || 'student').replace(/[^a-zA-Z0-9_-]/g,'_');
      

      if(!silent){
  document.getElementById('fullscreenLoader').style.display = 'flex';
  uploadToDrive(dataURL, safeAdmn);
}

    }
    

    /**********************************************************************
     * Upload final card & raw photo to Google Apps Script
     **********************************************************************/
    function uploadToDrive(dataURL, safeAdmn){
      // dataURL format: data:image/png;base64,XXXXX
      const base64Image = dataURL.split(',')[1];

      // Raw cropped photo (already sized) also send
      const rawPhotoData = croppedPhotoImg.src.split(',')[1];

      const scriptURL = 'https://script.google.com/macros/s/AKfycbykr5tjous0QZggMnM9WoFQKCFYkve1kUsvsLPCCEuvfoftzD0yj1FM3pny3NibrRX7/exec';

      const formData = new FormData();
      formData.append('image', base64Image);
      formData.append('filename', `Student_ID_${safeAdmn}.png`);
      formData.append('photo', rawPhotoData);
      formData.append('photoName', `Passport_Photo_${safeAdmn}.png`);
      formData.append('admn',   inpAdmn.value);
      formData.append('name',   inpName.value);
      formData.append('pen',    inpPEN.value);
      formData.append('child',  inpChild.value);
      formData.append('father', inpFather.value);
      formData.append('cell',   inpCell.value);

      fetch(scriptURL, {method:'POST', body:formData})
  .then(r => r.text())
  .then(txt => {
    document.getElementById('fullscreenLoader').style.display = 'none'; // hide loading
    alert('Upload complete!\n' + txt);
    location.reload(); // ðŸ”„ reload page after upload success
  })
  .catch(err => {
    document.getElementById('fullscreenLoader').style.display = 'none'; // hide loading
    console.error('Upload error:', err);
    alert('Upload failed.');
  });
}
  </script>
</body>
</html>
