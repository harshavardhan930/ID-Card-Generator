<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
   <title>Mehar Gayatri Digitals</title>
  <link rel="icon" href="logo.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>

<style>
:root{
  --primary:#2563eb;
  --bg:#0f172a;
  --card:#020617;
  --border:#475569;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Segoe UI,system-ui,sans-serif;
  background:var(--bg);
  color:#fff;
  padding:15px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.form-container{
  width:100%;
  max-width:1050px;
  background:var(--card);
  padding:20px;
  border-radius:12px;
  border:1px solid var(--border);
  margin-bottom:30px;
}

input,button{
  width:100%;
  padding:14px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#0f172a;
  color:#fff;
  font-size:16px;
}

input[type="date"]::-webkit-calendar-picker-indicator{
  filter:invert(1);
}

button{
  background:var(--primary);
  border:none;
  cursor:pointer;
  font-weight:600;
}

.generated-wrapper{
  width:100%;
  max-width:1050px;
  display:flex;
  flex-direction:column;
  gap:30px;
}

.generated-wrapper img{
  width:100%;
  aspect-ratio:1050/690;
  border:3px solid var(--primary);
  border-radius:12px;
}

/* Loader */
#fullscreenLoader{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.85);
  backdrop-filter:blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.loader-box{
  text-align:center;
}

.loader-box::before{
  content:"";
  width:50px;
  height:50px;
  border:5px solid rgba(255,255,255,.2);
  border-top:5px solid var(--primary);
  border-radius:50%;
  display:block;
  margin:0 auto 15px;
  animation:spin 1s linear infinite;
}

@keyframes spin{100%{transform:rotate(360deg)}}
</style>
</head>

<body>

<div class="form-container">
<h2>Front Card Details</h2>
<input id="inputAdmn" placeholder="CFMS No *">
<input id="inputName" placeholder="Name *">
<input id="inputPEN" placeholder="Husband's Name *">
<input id="inputChild" placeholder="Designation *">
<input id="inputFather" type="date">
<input id="inputCell" placeholder="Place of Working *">

<h2>Back Card Details</h2>
<input id="inputAddress" placeholder="Address *">
<input id="inputTreasury" placeholder="Treasury ID No *">
<input id="inputAadhaar" placeholder="Aadhaar No *">
<input id="inputContact" placeholder="Contact No *">

<input type="file" id="photoInput" accept="image/*">

<div id="crop-area">
  <img id="cropImage" style="max-width:100%;display:none">
</div>

<button onclick="cropAndStorePhoto()">Preview ID Card</button>
<button onclick="generateID()">Upload ID Card</button>
</div>

<div class="generated-wrapper">
  <img id="generatedPreview">
  <img id="generatedPreviewBack">
</div>

<canvas id="finalCanvas" width="1050" height="690" style="display:none"></canvas>
<canvas id="backCanvas" width="1050" height="690" style="display:none"></canvas>

<div id="fullscreenLoader">
  <div class="loader-box">
    <p>Uploading‚Ä¶ Please wait</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
const CARD_W=1050, CARD_H=690;
let cropper,croppedPhotoImg,originalPhotoFile=null;
const ctx=finalCanvas.getContext("2d");
const backCtx=backCanvas.getContext("2d");

/* Templates */
const frontImg=new Image();
frontImg.src="Teacher Front.jpg";

const backImg=new Image();
backImg.src="Teacher Back.jpg";

/* Coordinates */
const coords={
  photo:{x:71,y:216,w:234,h:289},
  admn:{x:560,y:292,size:26},
  name:{x:560,y:332,size:26},
  pen:{x:560,y:372,size:26},
  child:{x:560,y:412,size:26},
  father:{x:560,y:452,size:26},
  cell:{x:560,y:492,size:26}
};

const backCoords={
  address:{x:400,y:220,size:26,maxWidth:540},
  treasury:{x:620,y:422,size:26},
  aadhaar:{x:620,y:455,size:26},
  contact:{x:620,y:492,size:26}
};

/* Utilities */
function drawText(ctx,text,x,y,size,color="#000"){
  ctx.fillStyle=color;
  ctx.font=`bold ${size}px Arial`;
  ctx.textAlign="left";
  ctx.fillText(text,x,y);
}

function drawMultilineText(ctx,text,x,y,maxWidth,lineHeight,fontSize,color){
  ctx.fillStyle=color;
  ctx.font=`bold ${fontSize}px Arial`;
  let words=text.split(" ");
  let line="",cy=y;
  for(let w of words){
    let test=line+w+" ";
    if(ctx.measureText(test).width>maxWidth){
      ctx.fillText(line,x,cy);
      line=w+" ";
      cy+=lineHeight;
    }else line=test;
  }
  ctx.fillText(line,x,cy);
}

/* Validation */
function validateForm(){
  const fields=[
    inputAdmn,inputName,inputPEN,inputChild,inputFather,
    inputCell,inputAddress,inputTreasury,inputAadhaar,inputContact
  ];
  for(let f of fields){
    if(!f.value.trim()){
      alert("‚ö†Ô∏è Please fill all required fields.");
      f.focus();
      return false;
    }
  }
  if(!originalPhotoFile){
    alert("‚ö†Ô∏è Please upload a photo.");
    return false;
  }
  if(!croppedPhotoImg){
    alert("‚ö†Ô∏è Please preview the ID card before uploading.");
    return false;
  }
  return true;
}

/* Photo */
photoInput.onchange=e=>{
  originalPhotoFile=e.target.files[0];
  cropImage.src=URL.createObjectURL(originalPhotoFile);
  cropImage.style.display="block";
  cropImage.onload=()=>{
    if(cropper) cropper.destroy();
    cropper=new Cropper(cropImage,{aspectRatio:259/270});
  };
};

function cropAndStorePhoto(){
  if(!cropper){
    alert("‚ö†Ô∏è Upload and crop photo first.");
    return;
  }
  const c=cropper.getCroppedCanvas({width:259,height:270});
  croppedPhotoImg=new Image();
  croppedPhotoImg.src=c.toDataURL();
  croppedPhotoImg.onload=()=>generateID(true);
}

/* Generate */
function generateID(preview=false){
  if(!preview && !validateForm()) return;

  ctx.clearRect(0,0,CARD_W,CARD_H);
  ctx.drawImage(frontImg,0,0,CARD_W,CARD_H);
  ctx.drawImage(croppedPhotoImg,coords.photo.x,coords.photo.y,coords.photo.w,coords.photo.h);

  drawText(ctx,inputAdmn.value,coords.admn.x,coords.admn.y,coords.admn.size);
  drawText(ctx,inputName.value,coords.name.x,coords.name.y,coords.name.size);
  drawText(ctx,inputPEN.value,coords.pen.x,coords.pen.y,coords.pen.size);
  drawText(ctx,inputChild.value,coords.child.x,coords.child.y,coords.child.size);
  drawText(ctx,inputFather.value,coords.father.x,coords.father.y,coords.father.size);
  drawText(ctx,inputCell.value,coords.cell.x,coords.cell.y,coords.cell.size);

  generatedPreview.src=finalCanvas.toDataURL();

  backCtx.clearRect(0,0,CARD_W,CARD_H);
  backCtx.drawImage(backImg,0,0,CARD_W,CARD_H);

  drawMultilineText(backCtx,inputAddress.value,
    backCoords.address.x,
    backCoords.address.y,
    backCoords.address.maxWidth,
    34,
    backCoords.address.size,
    "#000"
  );

  drawText(backCtx,inputTreasury.value,backCoords.treasury.x,backCoords.treasury.y,26);
  drawText(backCtx,inputAadhaar.value,backCoords.aadhaar.x,backCoords.aadhaar.y,26);
  drawText(backCtx,inputContact.value,backCoords.contact.x,backCoords.contact.y,26);

  generatedPreviewBack.src=backCanvas.toDataURL();

  if(!preview) upload();
}

/* Upload */
function upload(){
  // Show loader if you have one
  document.getElementById('fullscreenLoader').style.display = 'flex';

  const admn = inputAdmn.value.trim() || "UNKNOWN";
  const safeAdmn = admn.replace(/[^a-zA-Z0-9_-]/g,'_');

  // Front image
  const frontDataURL = finalCanvas.toDataURL('image/png');
  const frontBase64  = frontDataURL.split(',')[1];

  // Back image
  const backDataURL = backCanvas.toDataURL('image/png');
  const backBase64  = backDataURL.split(',')[1];

  const scriptURL =
    "https://script.google.com/macros/s/AKfycbw5ehw8bn1ozKM1pSTZMfjdqgBzwzqVpYwe0a0jj_FqxgMctjb_PYW5DjC_vhw-Q5M6pA/exec";

  const formData = new FormData();

  // üîπ FRONT
  formData.append("frontImage", frontBase64);
  formData.append("frontName", `${safeAdmn}_FRONT.png`);

  // üîπ BACK
  formData.append("backImage", backBase64);
  formData.append("backName", `${safeAdmn}_BACK.png`);

  // Optional metadata
  formData.append("admn", admn);
  formData.append("name", inputName.value.trim());
  formData.append("pen", inputPEN.value.trim());
  formData.append("child", inputChild.value.trim());      // DOB
  formData.append("father", inputFather.value.trim());
  formData.append("cell", inputCell.value.trim());
  formData.append("address", inputAddress.value.trim());
  formData.append("aadhaar", inputAadhaar.value.trim());
  formData.append("contact", inputContact.value.trim());
  formData.append("treasury", inputTreasury.value.trim());
  
  if (originalPhotoFile) {
  formData.append(
    "originalPhoto",
    originalPhotoFile,
    `${safeAdmn}_PHOTO.${originalPhotoFile.name.split('.').pop()}`
  );
}


  fetch(scriptURL, {
    method: "POST",
    body: formData
  })
  .then(res => res.text())
  .then(txt => {
    // document.getElementById('fullscreenLoader').style.display = 'none';
    alert("‚úÖ Front & Back uploaded successfully\n" + txt);
    location.reload();
  })
  .catch(err => {
    // document.getElementById('fullscreenLoader').style.display = 'none';
    console.error(err);
    alert("‚ùå Upload failed");
  });
}

</script>

</body>
</html>
